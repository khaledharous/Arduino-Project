#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <Servo.h>

const char* ssid = "ZTE_nh2GKC";       // اسم الشبكة اللاسلكية
const char* password = "MOHAMEDFATIMA1920";  // كلمة مرور الشبكة اللاسلكية

ESP8266WebServer server(80);
Servo myservo;
int open_duration = 159;  // مدة فتح البوابة بالميللي ثانية (10 ثواني)

void handleRoot() {
  String html = "<html><body>";
  html += "<h1>Control the Door</h1>";
  html += "<button onclick=\"location.href='/open'\">OPEN</button>";
  html += "<button onclick=\"location.href='/close'\">CLOSE</button>";
  html += "</body></html>";
  server.send(200, "text/html", html);
}

void handleOpen() {
  myservo.write(180);  // دوران ضد عقارب الساعة لفتح الباب
  delay(open_duration);
  myservo.write(90);   // إيقاف الحركة
  delay(10000);         // فترة توقف بعد الفتح

  server.send(200, "text/html", "<html><body><h1>Door Opened</h1><button onclick=\"location.href='/'\">Back</button></body></html>");
}

void handleClose() {
  myservo.write(0);  // دوران باتجاه عقارب الساعة لإغلاق الباب
  delay(open_duration);
  myservo.write(90);  // إيقاف الحركة
  delay(10000);        // فترة توقف بعد الإغلاق

  server.send(200, "text/html", "<html><body><h1>Door Closed</h1><button onclick=\"location.href='/'\">Back</button></body></html>");
}

void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);

  // الانتظار حتى الاتصال بالشبكة
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }

  Serial.println("Connected to WiFi");

  // تعيين السيرفو إلى دبوس D2
  myservo.attach(D2);

  // إعداد مسارات HTTP
  server.on("/", handleRoot);
  server.on("/open", handleOpen);
  server.on("/close", handleClose);

  // بدء خادم الويب
  server.begin();
  Serial.println("HTTP server started");
}

void loop() {
  server.handleClient();
}
